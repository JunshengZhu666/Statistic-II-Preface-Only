/* 2020ass07 - subsample */

data ass07;
/*Obs trt plot subplot Wt */
input Obs trt$ plot subplot Wt;

cards;
1		A	1	1	13.9
2		A	1	2	15.5
3		A	1	3	18.4
4		A	1	4	21.4
5		A	2	5	20.2
6		A	2	6	15.8
7		A	2	7	26.7
8		A	2	8	21.1
9		A	3	9	16.3
10		A	3	10	22.7
11		A	3	11	11.2
12		A	3	12	20.9
13		A	4	13	22.0
14		A	4	14	19.8
15		A	4	15	20.4
16		A	4	16	20.6
17		A	5	17	17.3
18		A	5	18	19.5
19		A	5	19	15.3
20		A	5	20	19.7
21		B	6	21	17.1
22		B	6	22	14.8
23		B	6	23	15.1
24		B	6	24	12.9
25		B	7	25	14.5
26		B	7	26	12.8
27		B	7	27	9.1
28		B	7	28	13.0
29		B	8	29	21.8
30		B	8	30	16.0
31		B	8	31	17.3
32		B	8	32	14.7
33		B	9	33	9.2
34		B	9	34	10.6
35		B	9	35	5.9
36		B	9	36	8.6
37		B	10	37	15.1
38		B	10	38	21.3
39		B	10	39	15.5
40		B	10	40	14.4
41		C	11	41	11.9
42		C	11	42	14.9
43		C	11	43	20.1
44		C	11	44	16.6
45		C	12	45	16.6
46		C	12	46	13.9
47		C	12	47	15.3
48		C	12	48	17.5
49		C	13	49	29.5
50		C	13	50	22.5
51		C	13	51	24.7
52		C	13	52	24.7
53		C	14	53	15.1
54		C	14	54	16.3
55		C	14	55	15.0
56		C	14	56	19.4
57		C	15	57	15.5
58		C	15	58	22.1
59		C	15	59	17.2
60		C	15	60	17.9
61		D	16	61	10.4
62		D	16	62	14.1
63		D	16	63	15.3
64		D	16	64	17.8
65		D	17	65	17.9
66		D	17	66	13.5
67		D	17	67	18.3
68		D	17	68	20.4
69		D	18	69	16.4
70		D	18	70	11.6
71		D	18	71	17.5
72		D	18	72	21.8
73		D	19	73	12.8
74		D	19	74	12.2
75		D	19	75	9.7
76		D	19	76	12.1
77		D	20	77	13.6
78		D	20	78	10.3
79		D	20	79	15.2
80		D	20	80	13.2
;

proc iml;
reset print;
x = {1		1	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		1	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0	,
	1		0	1	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0	,
	1		0	0	1	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1		0	0	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		1	0	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	1	0	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	1	0	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	1	0	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1	,
	1		0	0	0	1		0	0	0	0	0		0	0	0	0	0		0	0	0	0	0		0	0	0	0	1	};

	y = {13.9	,
		15.5	,
		18.4	,
		21.4	,
		20.2	,
		15.8	,
		26.7	,
		21.1	,
		16.3	,
		22.7	,
		11.2	,
		20.9	,
		22	,
		19.8	,
		20.4	,
		20.6	,
		17.3	,
		19.5	,
		15.3	,
		19.7	,
		17.1	,
		14.8	,
		15.1	,
		12.9	,
		14.5	,
		12.8	,
		9.1	,
		13	,
		21.8	,
		16	,
		17.3	,
		14.7	,
		9.2	,
		10.6	,
		5.9	,
		8.6	,
		15.1	,
		21.3	,
		15.5	,
		14.4	,
		11.9	,
		14.9	,
		20.1	,
		16.6	,
		16.6	,
		13.9	,
		15.3	,
		17.5	,
		29.5	,
		22.5	,
		24.7	,
		24.7	,
		15.1	,
		16.3	,
		15	,
		19.4	,
		15.5	,
		22.1	,
		17.2	,
		17.9	,
		10.4	,
		14.1	,
		15.3	,
		17.8	,
		17.9	,
		13.5	,
		18.3	,
		20.4	,
		16.4	,
		11.6	,
		17.5	,
		21.8	,
		12.8	,
		12.2	,
		9.7	,
		12.1	,
		13.6	,
		10.3	,
		15.2	,
		13.2	};

		print "X transpose X";
		xtx = x` * x;
		print " ";
		print "X transpose Y";
		xty = x` * y;

		tss = y` * y;

		invxtx = ginv(xtx);

		btilde = invxtx * xty;

		sumy = sum(y);
		nobs = nrow(x);
		rx = 20; /* rank of X */
		dfe = nobs - rx;
		ybar = sumy/ nobs;
		cf = nobs * ybar *ybar;

		ssr = btilde` * xty;
		ssrm = ssr - cf;

		msr = ssr/rx;
		msrm = ssrm/(rx-1);
		
		sse = tss - ssr;
		mse = sse/dfe;

		fm = msr/mse;
		fmean = cf/mse;
		fmrm = msrm/mse;

		
		/*compute tabulated F and Chi values */
		data tabulated;
		input ndf ddf prob;
		ftab = finv(1 - prob, ndf, ddf);
		chitab = cinv(1 - prob, ndf);
		cards;
		20 60 0.05
		1  60 0.05
		19 60 0.05
		3  16 0.05
		16 60 0.05
		16 . 0.025
		16 . 0.975
		60 . 0.025
		60 . 0.975
		;
		proc print data = tabulated;
		var ndf ddf prob ftab chitab;
		run;

		quit;

		title' ASS07 nested model GLM';
		proc glm data = ass07;
		class trt plot;
		model Wt = trt plot(trt)/xpx;
		random plot(trt)/test;
		lsmeans trt/ stderr pdiff adjust=bon e=plot(trt);
		estimate 'trt 1 -2' trt 1 -1 0 0 plot(trt) .2 .2 .2 .2 .2 	-.2 -.2 -.2 -.2 -.2 	0 0 0 0 0 				0 0 0 0 0;
		estimate 'trt 1 -3' trt 1 0 -1 0 plot(trt) .2 .2 .2 .2 .2 	0 0 0 0 0 				-.2 -.2 -.2 -.2 -.2	0 0 0 0 0;
		estimate 'trt 1 -4' trt 1 0 0 -1 plot(trt) .2 .2 .2 .2 .2 	0 0 0 0 0 				0 0 0 0 0  				-.2 -.2 -.2 -.2 -.2;
		estimate 'trt 2 -3' trt 0 1 -1 0 plot(trt) 0 0 0 0 0 			.2 .2 .2 .2 .2 		-.2 -.2 -.2 -.2 -.2 	0 0 0 0 0;
		estimate 'trt 2 -4' trt 0 1 0 -1 plot(trt) 0 0 0 0 0 			.2 .2 .2 .2 .2         0 0 0 0 0				-.2 -.2 -.2 -.2 -.2 ;
		estimate 'trt 3 -4' trt 0 0 1 -1 plot(trt) 0 0 0 0 0 			0 0 0 0 0				.2 .2 .2 .2 .2 		-.2 -.2 -.2 -.2 -.2 ;

		run;
		quit;

		title' ASS07 nested model MIXED';
		proc mixed data = ass07 lognote;
		class trt plot;
		model Wt = trt/ ddfm = kr;
		random plot(trt);
		/*LSmeans(trt) Q5 */
		lsmeans trt/ pdiff adjust=bon;
		/*difference of trts Q5 */

		run;

		title' ASS07 nested model MIXED(without random plot)';
		proc mixed data = ass07 lognote;
		class trt plot;
		model Wt = trt/ ddfm = kr;
		run;


